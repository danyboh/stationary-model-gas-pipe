% Калібрування емпіричного коефіцієнта в математичній моделі
% стаціонарного руху газу в магістральному газопроводі.
%
% Система ЗДР описує зв'язані профілі тиску p(x) та температури T(x)
% вздовж газопроводу. Калібрований коефіцієнт входить у систему рівнянь
% і впливає на розрахункові параметри на виході газопроводу.
%
% Калібрування мінімізує відносну похибку між розрахованим
% та експериментально виміряним параметром на виході газопроводу
% методом Левенберга-Марквардта (lsqnonlin).

clc; clear; close all;

%% Параметри газопроводу та потоку
P_inlet       = 66.6;    % тиск на вході, атм
T_inlet       = 40;      % температура газу на вході, C
Q_flow        = 3506;    % об'ємна витрата, тис. м^3/добу
L_pipeline    = 122000;  % довжина газопроводу, м

%% Експериментальні дані на виході газопроводу
Y_outlet_exp  = 48.5;    % виміряне значення параметра на виході

%% Налаштування калібрування
a_initial     = 3.5;     % початкове наближення коефіцієнта
a_lower       = 0.5;     % нижня межа
a_upper       = 10.0;    % верхня межа

%% Конфігурація розв'язувача
ode_options = odeset('RelTol', 1e-6, 'AbsTol', 1e-9, 'MaxStep', 100);
opt_options = optimoptions('lsqnonlin', ...
    'Display',              'iter', ...
    'FunctionTolerance',    1e-10, ...
    'StepTolerance',        1e-10, ...
    'OptimalityTolerance',  1e-10);

%% Запуск оптимізації
a_optimal = lsqnonlin( ...
    @(a) residual(a, P_inlet, T_inlet, Q_flow, ...
                  L_pipeline, Y_outlet_exp, ode_options), ...
    a_initial, a_lower, a_upper, opt_options);

fprintf('Оптимальне значення коефіцієнта: %.10f\n', a_optimal);

%% Функція нев'язки для оптимізатора
function r = residual(a, P_inlet, T_inlet, Q_flow, ...
                      L_pipeline, Y_outlet_exp, ode_options)
    % Перетворення вхідних параметрів у систему СІ
    p0 = P_inlet * 101325;         % Па
    T0 = T_inlet + 273.15;         % К
    Q  = Q_flow / 86.4;            % м^3/с

    % Початкові умови: [тиск; температура]
    y0 = [p0; T0];

    % Розв'язання зв'язаної системи ЗДР dp/dx, dT/dx вздовж газопроводу
    [~, y] = ode45( ...
        @(x, y) pipeline_ode_system(x, y, Q, a), ...
        [0, L_pipeline], y0, ode_options);

    % Розрахункове значення параметра на виході
    Y_outlet_calc = extract_output(y);

    % Відносна похибка як нев'язка для мінімізації
    r = (Y_outlet_calc - Y_outlet_exp) / Y_outlet_exp * 100;
end
